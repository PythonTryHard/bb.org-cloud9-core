From bd0f0a8e1b22379b9013da01eacdb18e05ae15de Mon Sep 17 00:00:00 2001
From: Robert Nelson <robertcnelson@gmail.com>
Date: Tue, 24 Feb 2015 14:55:19 -0600
Subject: [PATCH 2/2] bb.org: use systemd

Signed-off-by: Robert Nelson <robertcnelson@gmail.com>
---
 .../connect.remote-address/remote-address.js               | 14 +++-----------
 node_modules/connect-architect/connect/connect-plugin.js   |  8 ++++++--
 package.json                                               |  3 ++-
 3 files changed, 11 insertions(+), 14 deletions(-)

diff --git a/node_modules/connect-architect/connect.remote-address/remote-address.js b/node_modules/connect-architect/connect.remote-address/remote-address.js
index 963ba9c..5b4d64e 100644
--- a/node_modules/connect-architect/connect.remote-address/remote-address.js
+++ b/node_modules/connect-architect/connect.remote-address/remote-address.js
@@ -8,15 +8,7 @@ module.exports = function(options, imports, register) {
 };
 
 function remoteAddress(req, res, next) {
-    req.remoteAddress = 
-        req.headers['x-forwarded-for'] || 
-        req.socket.remoteAddress ||
-        req.connection.remoteAddress || 
-        req.connection.socket.remoteAddress;
-
-    req.proto = 
-        req.headers["x-forwarded-proto"] || 
-        (req.socket.encrypted ? "https" : "http");
-        
+    req.remoteAddress = "127.0.0.1";
+    req.proto = "http"
     next();
-}
\ No newline at end of file
+}
diff --git a/node_modules/connect-architect/connect/connect-plugin.js b/node_modules/connect-architect/connect/connect-plugin.js
index 6e64686..f60fc00 100644
--- a/node_modules/connect-architect/connect/connect-plugin.js
+++ b/node_modules/connect-architect/connect/connect-plugin.js
@@ -3,6 +3,7 @@ var netutil = require("netutil");
 var connect = require("connect");
 var http = require("http");
 var https = require("https");
+require('systemd');
 
 module.exports = function startup(options, imports, register) {
     var globalOptions = options.globals ? merge([options.globals]) : {};
@@ -123,7 +124,10 @@ module.exports = function startup(options, imports, register) {
             server = http.createServer(app);
         }
 
-        server.listen(port, host, function(err) {
+        //server.listen(port, host, function(err) {
+        console.log('LISTEN_FDS = ' + process.env.LISTEN_FDS);
+        server.listen('systemd');
+        server.on('listening', function(err) {
             if (err)
                 return register(err);
 
@@ -221,4 +225,4 @@ function merge(objects) {
         }
     }
     return result;
-}
\ No newline at end of file
+}
diff --git a/package.json b/package.json
index 27aea25..881f953 100644
--- a/package.json
+++ b/package.json
@@ -34,6 +34,7 @@
         "rusha": "~0.7.2",
         "send": "~0.1.4",
         "simple-mime": "~0.0.8",
+        "systemd": "~0.2.6",
         "tern": "git://github.com/lennartcl/tern.git#97464df789dbb4d81ca4579383a02b320c69563d",
         "tern_from_ts": "git://github.com/cloud9ide/tern_from_ts.git#b8b3d555e545aa41ed8d0df054ef38416a578faa",
         "through": "2.2.0",
@@ -104,4 +105,4 @@
         "c9.ide.upload": "#0bd010d3dc",
         "c9.ide.welcome": "#b4be5c22a5"
     }
-}
\ No newline at end of file
+}
-- 
2.1.4

